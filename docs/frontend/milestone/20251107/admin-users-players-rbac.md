# 2025-11-07 前端：后台用户/玩家拆分 & RBAC 交互 Todo

## 背景与目标
- 后台“用户管理”页面需要拆成「站内用户列表」与「AuthMe 玩家列表」，各自提供独立的筛选、分页、操作入口；
- 玩家列表依赖 AuthMe 数据库，存在连接不稳定，需要明显的状态提示与降级回退；
- 用户详情页必须补齐管理员操作（删除用户、修改绑定、重置密码），禁止出现“等待功能完善”提示；
- 玩家详情需展示完整的绑定流转时间线，管理员可查看并手动补录事件；
- RBAC 管理页要支持多权限组叠加、Label（可无权限），并提供权限节点总览与自助申请入口。

## Todo List

### 一、信息架构与路由
- [x] 调研现有后台路由与组件（`AdminUsersView`, `AdminRBACView` 等），确认可复用的布局/表格组件。
- [x] 在路由中新增：
  - [x] `/admin/users`：站内用户列表；
  - [x] `/admin/players`：AuthMe 玩家列表；
  - [x] `/admin/rbac`：扩展子路由 `catalog`, `roles`, `labels`, `self-assign`。
- [ ] 更新侧边栏导航，拆分原有“用户管理”入口，并在路由守卫里处理权限点。

### 二、站内用户列表与操作
- [x] 列展示：用户名、邮箱、角色标签、绑定数量、主绑定玩家、最后登录、状态。
- [ ] 操作列：
  - [x] `查看详情`：进入用户详情抽屉/页面；
  - [ ] `修改绑定`：弹窗选择玩家、设为主绑定、解绑；
  - [x] `重置密码`：确认弹窗 + 成功提示；
  - [x] `删除用户`：二次确认 + 结果 toast。
- [ ] 过滤需求：关键词、角色、绑定状态、是否存在主绑定。

### 三、AuthMe 玩家列表
- [x] 表格字段：AuthMe 用户名、UUID、最近登录时间、最后 IP、绑定状态（已关联/未关联）、关联站内用户（可多）、最新流转事件摘要。
- [x] Status Banner：当后端返回 `sourceStatus=degraded` 时，顶部展示黄色告警并提供“重试”按钮。
- [ ] 动作：
  - [ ] `绑定到用户`：选择目标站内用户并触发 API；
  - [ ] `查看流转`：打开时间线抽屉，显示历史事件；
  - [ ] `补录事件`：手动填写 action + remark。
- [x] 支持分页与快速搜索，空态需展示 AuthMe 连接状态。

### 四、用户/玩家详情页面
- [x] 用户详情页包含：基础信息卡片、绑定列表（带主标识、操作按钮）、操作历史（删除/重置/绑定调整）时间线。
- [ ] 玩家详情页：AuthMe 基础信息 + 绑定用户列表 + 完整流转时间线（按时间倒序），支持导出 CSV。
- [x] 时间线组件需接受 `operation`, `operator`, `reason`, `metadata`，并按类型渲染不同图标。

### 五、RBAC 管理页重构
- [ ] 角色列表：可勾选多个角色分配给同一用户，UI 提示“已叠加”并展示合并后的权限数量。
- [x] Label 管理：
  - [ ] 提供创建/编辑弹窗，可不选择任何权限；
  - [x] 列表展示 Label 名称、描述、绑定人数。
- [x] 权限目录页：
  - [x] 表格/树状结构列出全部权限节点、模块、描述、默认角色；
  - [x] 支持关键字搜索、模块折叠（前端以 key 前缀分组，无后端 module 字段时使用首段作为模块名）。
- [x] 自助申请：
  - [x] 页面列出当前管理员缺失的关键权限，点击后触发 `self-assign` API 并要求二次确认；
  - [x] 展示权限来源（角色/label/单独赋予）。

### 六、状态管理与接口对接
- [x] 更新 Pinia store（或等价状态层）以拆分 `fetchUsers`, `fetchPlayers`, `fetchRoleCatalog` 等方法；
- [ ] 所有写操作需乐观/悲观策略明确：删除/重置采用悲观刷新，绑定调整可乐观更新；
- [ ] 错误提示统一放在 Notify/Toast 中，含后端返回的 degraded 信息。

### 七、体验与可用性
- [x] 确保所有按钮/菜单无「等待功能完善」文案，缺功能时以禁用态 + tooltip 说明原因；
- [x] 新增空态插画/提示文本，覆盖无数据、加载失败、AuthMe 未连接三种状态；
- [ ] （已确认无需导出功能）

### 八、补充新增需求（2025-11-07 用户反馈，已调整：导出取消）
- [ ] RBAC 角色编辑：在 `roles` Tab 内为非系统角色添加“编辑”与“删除”按钮（对接现有后端 PATCH/DELETE）。
- [ ] RBAC 权限标签：添加“新建标签”按钮与编辑弹窗（可空权限），支持删除（确认二次操作）。
- [x] RBAC 权限点：搜索框（按 key / 描述模糊），模块分组折叠（当前用首段前缀模拟，后端未来可补充 module 字段）。
- [ ] 权限合并预览组件：在用户详情页或角色分配弹窗，实时展示所选角色+标签+自助权限合并后的去重集合与总数。
- [ ] 用户详情：增加“解绑”按钮单独对某个绑定执行 `DELETE /auth/users/:id/bindings/:bindingId`（待后端补接口）。
- [ ] 用户详情：添加“修改绑定信息”按钮（备注、状态）调用 `PATCH /auth/users/:id/bindings/:bindingId`。
- [ ] 玩家列表：行内操作列新增“绑定到用户”与“查看时间线”按钮；补录事件弹窗（action、reason、payload JSON）。
- [ ] 玩家详情页：新增单页面 `/admin/players/:username`（若后端补充 `GET /auth/players/:username`）。
- [ ] 自助申请：输入框下方显示“已拥有权限”自动过滤后只提交缺失集合；返回结果高亮新增的节点。
- [x] 导出功能取消：不再实现 CSV/JSON 导出。
- [ ] 全局：出现后端 `sourceStatus=degraded` 时在顶部全局 Banner 汇总提示并刷新重试按钮。

### 九、实现优先级（前端）
1. RBAC 角色/标签编辑与删除（已具备后端接口）
2. 玩家列表操作列（绑定、时间线、补录事件）
3. 用户详情绑定解绑与编辑弹窗
4. 权限合并预览组件与自助申请优化
5. 导出功能（历史与目录）
6. 全局 degraded Banner 与重试机制

### 十、风险与边界
- AuthMe 数据源不可用：前端需区分缓存 vs 真正无数据；在空态展示“数据源降级”并提供重试按钮，仅触发玩家列表刷新。
- 自助权限频繁操作可能导致标签膨胀：前端提示“请谨慎申请，建议一次性填写多个权限”。
- 角色删除后前端列表需立即同步（悲观刷新）。

### 十一、设计与组件复用计划
- 使用现有表格样式组件（UserDirectory / PlayerDirectory）抽象出 `AdminDataTable`，支持列定义、空态、分页回调。
- 权限合并预览利用 Pinia getters：`mergedPermissions = new Set([...rolesPerms, ...labelsPerms, ...selfPerms])`。
- 导出使用浏览器 Blob + URL.createObjectURL，无需后端支持 CSV 时直接处理；JSON 直接 `JSON.stringify`。
