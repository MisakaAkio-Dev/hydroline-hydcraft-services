# 行政系统规划（草案 v0.1，2026-01-09）

## 0. 背景（从用户视角出发）

你当前在「注册单位 / 有限责任公司登记信息」里看到的“住所地所在地区（三级）”，本质上是工商系统里的一段“世界行政区划”能力：

- 数据源：后端配置中心 `world.admin_divisions/divisions_v1`（目前只是示例：氢气/沁京/江户）。
- 形态：固定 1/2/3 级；没有“服务端/世界”的维度；也没有“地方管理员/地方自治”的权限体系。
- 体验问题：二级/三级下拉只有在输入搜索词时才会触发查询，因此“选了一级但二级仍为空”对用户来说是“数据不存在/坏了”。

但你的需求已经明显超过“工商系统里的行政区划选择器”：

1. 你需要一个**独立的「行政系统」**（前后端都有独立 API 与文件夹分类），管理后台要有页面，并且在后台侧边栏里作为一个新分类「行政系统」放在「工商系统」上面。
2. 你希望管理员能提前定义**服务器的行政制度**（有几级、每级是什么“行政区类型/后缀”），然后再按制度去分配行政区与地方管理权。
3. 行政区创建后应能按“行政模式”自动生成地方机构，并进一步在工商系统里生成对应的机关法人（账号/公司实体），用于后续任命与运行。
4. 你担心“行政模式”在用户可自定义行政级别/名称的前提下会变得难以约束：哪些行政区能选哪些行政模式？如何受上级制约？是否需要勾选按钮？勾选什么？

本文件的目标：把上述“树洞式需求”整理成一套可落地的系统设计与分阶段 MVP 计划，并补齐冲突/缺失点。

---

## 1. 核心目标（你希望“直接看见”的能力）

### 1.1 独立系统与导航位置

- 新增「行政系统」：后端独立模块/路由前缀；前端独立目录与路由。
- 后台导航：新增菜单组「行政系统」，放在「工商系统」之上。
- 管理后台页面：至少具备“行政制度配置”“行政区管理”“地方管理员分配”“行政模式/机构预览（或配置）”。

### 1.2 管理员可配置的“行政制度”

管理员可以配置（按服务端/世界维度）：

- 行政等级数量：例如 2/3/4/… 级（不再固定三级）。
- 每一级允许的“行政区类型”（例如：都、县、市、州…），以及该类型的显示规则：
  - 后缀：如“县”“市”“州”“省”。
  - 简称规则（可选）：例如“直辖市 → 市”；很多类型不需要简称则留空。
  - 专名：用户输入“江户”，系统按类型规则组成“江户县/江户市”等。

### 1.3 行政区创建与地方自治

- 管理员必须创建/指定一级行政区（顶层区域），并可指派多个“地方管理员”。
- 下级行政区可由地方管理员按制度规则自行创建（级别必须匹配、不可跳级/乱挂父级）。
- 若创建行政区时未指派地方管理员，则该行政区只能由后台具备相应全局权限的人来补指派（避免“无人可管”）。

### 1.4 行政模式（预置）与自动生成机构/机关法人

你希望：

- 行政模式是系统预置（用户不能自定义），只允许在满足条件的行政区选择。
- 行政区选择某行政模式后，系统自动创建该行政区的机构与对应的机关法人账号（工商系统里的实体），例如：
  - 党委制：江户县人民政府、江户县委员会、江户县人民法院、政协、人大……
  - 议会制：江户县议会、江户县政府、江户县法院……
- 机构本质上共享/分割“权力”，需要找到不同政治制度的共通抽象来做分类与权限映射。

---

## 2. 术语与抽象（把“说不清”变成系统能表达的模型）

### 2.1 服务端（Server）

对应现有数据模型 `MinecraftServer`（uuid），在你的需求中相当于“世界/服务器实例”的边界：  
同一个服务器可能有完全不同的行政制度与行政区划树。

### 2.2 行政制度（Administrative Regime）

一套“规则模板”，描述：

- 该制度有多少级（levelCount）。
- 每一级允许哪些“行政区类型”（Division Type）。
- 该制度允许哪些“行政模式”（Governance Model）。
- 该制度是否允许下级自治创建、以及默认继承规则。

### 2.3 行政区类型（Division Type）

对“都/县/市/州/省/直辖市”等做结构化描述：

- `name`（类型名）：县 / 市 / 都 / 直辖市…
- `suffix`（后缀）：县 / 市 / 都…
- `abbr`（简称规则，可空）：直辖市 → 市（或留空代表不使用）
- `allowedLevels`：允许出现在哪些级（例如“市”可出现在二级或三级，取决于制度）

### 2.4 行政区（Division）

树节点，核心字段建议拆为：

- `properName`：专名（江户）
- `typeId`：行政区类型（县）
- `fullName`：展示名（江户县，由 properName + suffix 计算/缓存）
- `abbrName`：简称（若需要）
- `levelIndex`：第几级（1..N）
- `parentId`：父节点（levelIndex>1 必填）
- `serverId`：所属服务端（强绑定）
- `managers`：地方管理员列表（可多个）
- `governanceModelCode`：当前行政模式（可继承/可覆盖）

### 2.5 行政模式（Governance Model，预置）

系统内置的“治理结构模板”，关键不是名字，而是它会产出哪些“机构/权力域”。

### 2.6 权力域（Authority Domain，共通点）

为解决“不同制度共通点/可比较”问题，建议引入跨制度统一的权力域枚举（示例）：

- `EXECUTIVE`（行政/政府）
- `LEGISLATIVE`（立法/议会/人大）
- `JUDICIAL`（司法/法院）
- `PROSECUTORIAL`（检察）
- `PUBLIC_SECURITY`（公安）
- `PARTY`（党委/党务）
- `SUPERVISION`（监察/纪委）
- `CONSULTATIVE`（政协/协商）

行政模式 = 若干个权力域 + 机构模板组合（见下）。

### 2.7 机构模板（Institution Template，预置）

行政模式里定义要创建哪些机构：

- `domain`：归属哪个权力域
- `displayNamePattern`：如 `${division.fullName}人民政府`
- `companyTypeCode`：对应工商系统里的公司类型（如机关法人）
- `requiredRoles`：该机构内部可任命的岗位（市长/议长/书记…）——可以后置到下一阶段

---

## 3. 关键难点的设计答案（回应你的疑问）

### 3.1 “行政模式如何受上级制约？需要勾选按钮吗？”

建议用“继承/覆盖”的显式模型解决，不需要让用户猜“勾选什么”：

- 默认：**继承上级行政模式**（最安全、最符合“受上级制约”直觉）。
- UI 设计：在行政区创建/编辑时提供一个清晰开关：
  - `✅ 继承上级行政模式`（默认开启）
  - 关闭后出现下拉：`选择本级行政模式`
- 下拉选项来自“允许集合”：
  - 先由行政制度（Regime）定义“本级允许哪些模式”（按 levelIndex 或 divisionType 过滤）。
  - 再由上级行政区的模式定义“对子级的约束”（例如：某些上级模式禁止子级选议会制）。
  - 最终可选集合 = 制度允许 ∩ 上级允许。

这样“勾选按钮”就是“是否继承”，用户一眼能懂；约束逻辑也可控、可解释。

### 3.2 “在用户可自定义级别/类型名的前提下，怎么保证约束不崩？”

约束不要绑定“中文显示名”（市/县/都），而是绑定结构化字段：

- `levelIndex`（第几级）是稳定的；
- `divisionTypeId`（类型）是稳定的；
- “市在不同制度/不同层级含义不同”通过 `allowedLevels` + 制度配置解决；
- “同名不同权力”通过 `Authority Domain` 和机构模板解决，而不是通过名字猜。

---

## 4. 后端架构规划（独立模块 + 独立 API）

### 4.1 目录与路由建议

后端新增模块（示例命名）：

- `backend/src/administration/`
  - `administration.module.ts`
  - `controllers/`：
    - `admin-administration.controller.ts`（`/admin/administration/*`）
    - `public-administration.controller.ts`（`/administration/*`，如给前台读取）
  - `services/`：制度、行政区、约束校验、机构自动生成（Provisioning）
  - `dto/`：创建制度、创建行政区、分配管理员等

与工商系统的边界：

- 行政系统对外提供“行政区划/制度/模式”的权威数据；
- 工商系统只消费（读取）行政系统的结果，并在需要时由行政系统触发“创建机关法人公司”。

### 4.2 数据落库 vs 配置中心

现状 `world.admin_divisions` 是“配置中心数组”，适合小规模，但不适合：

- 多服务端隔离；
- 管理员/地方管理员权限与审计；
- 自动生成机构、联动工商系统；
- 复杂约束与演进。

建议新增 Prisma 表做“正式行政系统”数据源，并提供一次性迁移把旧 `world.admin_divisions` 导入（作为兼容）。

### 4.3 权限建议（RBAC）

新增权限常量（示例）：

- `administration.admin.view`：查看行政系统
- `administration.admin.manage`：全局管理行政系统
- `administration.admin.regimes`：管理行政制度
- `administration.admin.divisions`：管理所有行政区（跨区）
- `administration.local.divisions`：地方管理员管理自己辖区（创建下级、任命机构等）

并在行政区上做资源级校验：`local` 权限只对“自己是该行政区（或上级行政区）管理员”时生效。

---

## 5. 前端（管理后台）规划

### 5.1 导航与路由

- 在 `AdminShell` 菜单里新增组：`行政系统`，放在 `工商系统` 上面。
- 新增 `/admin/administration/*` 路由组，页面建议拆为：
  1. `行政制度`：等级数量、类型配置、可用行政模式配置
  2. `行政区管理`：按服务端筛选、树形维护、地方管理员分配、模式继承/覆盖
  3. `机构预览/生成记录`：展示某行政区会生成哪些机构/机关法人（便于确认）

### 5.2 行政区管理页面（用户真正想看到的交互）

- 左侧：服务端选择（Server Select）
- 中间：行政区树（Tree）
- 右侧：详情面板（Detail）
  - 基础信息：专名、类型、父级、自动生成的全名/简称
  - 地方管理员：多人选择与移除
  - 行政模式：继承开关 +（可选时）下拉
  - 自动创建机构：按钮/状态（创建后可查看对应工商系统实体）

---

## 6. 与工商系统的联动（机关法人自动创建）

### 6.1 目标

当行政区（比如“江户县”）确定了行政模式后，系统自动生成一组“机构”，并在工商系统创建对应的机关法人（Company）：

- 公司名称：按模板拼接（`${division.fullName}人民政府` 等）
- 公司类型：统一为 `state_organ_legal_person`（现有类型体系已支持）
- 公司所属行政区字段：写入 `administrativeDivisionId/Name/Level`

### 6.2 为什么要引入“机构模板”和“权力域”

避免未来扩展时陷入“每种制度写一套硬编码”：

- 不同制度的差异 = 机构集合不同、岗位不同；
- 共通部分 = 都是“权力域的承载者”，可用于权限、工作流、统计。

---

## 7. 你提出的第 ② 点：公司申请表改造（服务端 + 行政区）

### 7.1 需求整理

- 把当前申请表“一级行政区”改为“所属服务端”（uuid，显示服务端名）。
- 服务端列表由后端提供，且你希望“打开页面时”通过 company 相关接口拿到（而不是到处散落请求）。
- 行政区（真正的一级行政区）应来自新的行政系统。
- “二级行政区去掉”（你不想要中间那个空空的层级选择）。

### 7.2 建议的产品形态（兼容“可自定义 N 级”与“去掉二级”）

把“服务端”作为行政区划树的根维度：

1. 先选服务端（必选）。
2. 再按该服务端的制度显示“行政区选择器”：
   - 若该制度是 2 级：就只显示 2 个层级选择（自然“去掉二级”）。
   - 若该制度是 3/4 级：按配置显示对应数量的层级选择。

这样“去掉二级”不再是硬编码删字段，而是由制度配置决定页面层级数量；也能避免以后你又想加回 4 级时重做 UI。

### 7.3 接口建议（company 下的聚合 meta）

为减少前端初始化请求，建议新增一个聚合接口（示例）：

- `GET /companies/registration/meta`
  - `servers`: `{ id, displayName }[]`
  - `administration`: 当前服务端是否已配置制度、以及 levelCount/类型摘要（用于前端决定渲染几个层级）

行政区查询接口可选择两种路线（后续实现时二选一）：

- A. 继续走 company 兼容接口（快速迁移）：`/companies/geo/divisions/search` 增加 `serverId` 参数。
- B. 走行政系统接口（最终形态）：`/administration/servers/:serverId/divisions/search`（或类似）。

---

## 8. MVP 分阶段（按“先验证可行，再全面推广”的节奏）

> 目标：每阶段都能“跑起来”，并能在页面上直观看到价值；避免一次性改太多导致不可用。

### 阶段 0：需求确认（不写代码）

- 明确“服务端”是否就是 `MinecraftServer`（看起来是）。
- 明确每个服务端是否只允许一个“生效中的行政制度”。
- 明确公司登记只需要记录到哪一级（最末级？可配置？）。

### 阶段 1：申请表先变“可用”（最低风险）

- 前端：把“一级行政区”替换为“所属服务端”选择器。
- 后端：提供 `GET /companies/registration/meta` 返回服务端列表。
- 行政区选择暂时仍沿用旧 `world.admin_divisions`（先保证流程通）。

### 阶段 2：行政系统最小闭环（后台可配、前台可用）

- 后端新增行政系统模块 + Prisma 表：
  - 服务端维度的一套制度（levelCount、types）
  - 行政区树（N 级）
  - 地方管理员分配
- 管理后台页面：能配置制度、维护行政区、分配地方管理员。
- 申请表行政区数据改为读取新行政系统（并带 serverId 过滤）。

### 阶段 3：行政模式 + 自动生成机构/机关法人

- 内置 2 ～ 3 个行政模式（党委制/议会制/中国模式等），并绑定到制度/层级允许集合。
- 行政区选择模式后自动生成机构，并在工商系统创建机关法人公司（含名称模板）。
- 增加“预览将生成哪些机构”的确认 UI，避免误操作。

### 阶段 4：更深的“法人/主体”升级（可并行但建议后置）

- 你提到“法人系统不能等于公司”。建议先把行政系统落地后再升级主体模型：
  - 可能需要新 `LegalEntity`（主体）表，Company 只是其中一种“主体表现形态”；
  - 或者在现有 `CompanyCategory/CompanyType` 上扩展并引入“主体类型层”。

---

## 9. 待你补充确认的关键问题（避免后续返工）

1. “所属服务端”是否确认使用 `MinecraftServer.id`？显示名用 `displayName` 还是 `name`？
2. 一个服务端是否允许多个行政制度并存（历史/切换），还是只保留一个生效制度？切换后旧行政区怎么处理？
3. 行政区创建时，如果没有地方管理员：是禁止创建，还是允许创建但仅全局管理员可管理？你倾向哪一种？
4. 公司登记的住所地：需要精确到制度的最末级，还是允许选择任意级并记录 `administrativeDivisionLevel`？
5. 自动创建的机构公司：是否必须立刻可用（需要默认法人/岗位），还是只创建“空机构壳子”等待后续任命？
