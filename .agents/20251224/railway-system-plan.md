# 铁路系统功能规划（MVP -> 全量）

## 背景介绍
- 目标：在既有铁路模块的基础上，补齐“运营/建设单位”绑定、铁路系统（线路集）管理、地图多线路展示、跨页面联动展示等能力。
- 约束：仅引用公司数据库中“状态正常”的公司；尽量解耦，只存公司 ID；前端通过公司库查询详情。
- 权限：所有已注册用户都可分配/编辑。
- 复用：尽量基于已有铁路/线路/车厂/车站页面与地图组件进行复制改造，不直接改原组件以避免回归。

## Requirements
- 数据绑定
  - 铁路、车厂、线路均支持绑定多个“运营单位”和多个“建设单位”。
  - 绑定来源：公司数据库中状态正常的公司；使用 `u-select-menu` 搜索后加载选择。
  - UI 位置：基础信息区域最下方新增两个字段“运营单位”“建设单位”，旁边有“+”按钮弹窗搜索。
- 首页统计与入口
  - `transportation/railway` 首页新增“运营单位统计”与 router link。
  - 统计口径：被绑定的铁路运营单位总数（去重公司 ID）。
  - 点击进入统计页：展示铁路运营/建设单位统计列表（类似 `railway/depots`），可查看全部单位及名下相关信息/所属人。
- 新增入口按钮
  - 首页右上角已有管理员 Setting；其右侧新增所有用户可见“+”按钮。
  - 点击“+”提供两个入口：
    - “添加信息” -> 新建铁路系统
    - “编辑设施” -> 设施批量编辑页面
- 编辑设施（批量）
  - 页面形式参考“全部线路”表格样式。
  - 支持对线路/车厂/车站/线路批量编辑：运营单位、建设单位等绑定信息。
  - 预留可扩展入口：后续可追加更多字段。
- 铁路系统（线路集）
  - 创建：搜索铁路线路名称，选择线路组成系统。
  - 线路同名规则：仅允许同名线路加入（`split('||')[0].split('|')[0]` 规范化名称）。
  - 可编辑：任何人可编辑系统。
  - 系统详情页：
    - 线路系统名、英文名、Logo（支持上传图片与 SVG）。
    - 地图展示：全屏/非全屏地图复制现有线路地图逻辑，渲染多线路拼合；显示换乘站（同站点 ID 视为换乘）。
    - SVG 展示：拼接多线路 SVG 且保持颜色区分。
    - 系统下方双栏信息布局（不包含 MTR ID）。
    - 系统需至少绑定一个运营单位；支持添加多个运营单位/建设单位。
    - 支持多个 mod 共存，但不允许跨服务端、跨维度；允许显示相关线路系统入口。
  - 路由：系统详情不带 mtr 参数。
- 线路详情联动
  - 单条线路页面“基础信息”下方展示所属线路系统的 Logo + 名称，并提供内链跳转到系统详情。

## 待确认问题（需要你回答）
- 运营/建设单位统计页的字段与排序规则：是否与 `railway/depots` 完全一致？
- 公司库的“状态正常”字段命名是什么？是否存在统一的 `companyLib` 供查询？
- 附件系统是否已支持 SVG 上传与预览？若有，路径/组件是哪个？
- “所属人”字段来源：公司表还是现有绑定关系表？
- “不允许跨维度”的维度定义（例如：城市/国家/线路类型/mod？）

---

# Todolist（按模块拆分）

## 1. 数据模型与公司库解耦
- [x] 盘点铁路/车厂/线路/车站的现有绑定字段结构（是否已有 companyId 列表）
- [x] 新增/扩展绑定字段：`operatorCompanyIds`、`builderCompanyIds`（统一命名规范）
- [x] 新建或完善公司查询库 `companyLib`：
  - [x] 按 ID 拉取公司详情（批量）
  - [x] 仅返回状态正常的公司
  - [x] 统一数据结构供前端展示
- [x] 明确保存策略：仅存公司 ID，页面展示通过 `companyLib` 拉取

## 2. 基础信息 UI：运营/建设单位绑定
- [x] 铁路详情页基础信息区新增“运营单位/建设单位”区块（支持多选展示）
- [x] 车厂详情页基础信息区新增“运营单位/建设单位”区块
- [x] 线路详情页基础信息区新增“运营单位/建设单位”区块
- [x] “+”按钮弹窗：`u-select-menu` 搜索公司库（状态正常）
- [x] 点击选择后写入对应绑定字段，保存并更新展示

## 3. 首页统计与运营/建设单位统计页
- [x] 在 `transportation/railway` 首页新增统计卡片“运营单位”
- [x] 统计逻辑：从铁路绑定关系中去重公司 ID
- [x] 新增路由与页面：铁路运营/建设单位统计页
- [x] 页面结构对齐 `railway/depots`：
  - [x] 列表展示公司信息、名下铁路/线路/车厂/车站数量等
  - [x] 单位详情页：查看全部单位及名下相关信息、所属人

## 4. 首页新增“+”入口与导航
- [x] 首页右上角新增“+”按钮（所有用户可见）
- [x] 弹出菜单：
  - [x] “添加信息” -> 新建铁路系统
  - [x] “编辑设施” -> 设施批量编辑页
- [x] 新增对应路由与页面结构骨架

## 5. 编辑设施页（批量绑定）
- [x] 复用/复制“全部线路”表格结构到新页面
- [x] 支持批量编辑：线路/车厂/车站的运营/建设单位绑定
- [x] 批量保存策略：逐条或批量提交（根据现有 API 设计）
- [x] 预留扩展槽位：未来新增字段时不影响主结构

## 6. 铁路系统（线路集）创建与详情
- [x] 新建“铁路系统”数据结构与路由
- [x] 创建页面：
  - [x] 搜索铁路线路名称（基于现有线路库）
  - [x] 使用 `split('||')[0].split('|')[0]` 规范化同名线路
  - [x] 只允许同名线路加入系统
- [x] 详情页基础信息：
  - [x] 系统中文名、英文名、Logo（支持图片与 SVG 上传）
  - [x] 运营/建设单位绑定（至少一个运营单位）
- [x] SVG 拼接展示：多线路 SVG 合成 + 颜色区分
- [x] 地图展示：
  - [x] 非全屏地图复制现有线路地图逻辑并放大
  - [x] 全屏地图复制现有线路地图逻辑
  - [x] 多线路合并路径渲染（combinepath）
  - [x] 显示换乘站（站点 ID 相同）
- [x] 系统与线路关系：
  - [x] 系统下方双栏信息布局（移除 MTR ID）
  - [x] 相关线路系统展示入口（同 mod，不跨维度/服务端）

## 7. 线路详情页联动展示系统归属
- [x] 若线路已加入系统，在“基础信息”下方展示系统 Logo + 名称
- [x] 提供内链跳转到对应系统详情页

## 8. 验证与 MVP 策略
- [ ] 先完成单个铁路 + 单条线路的绑定流程验证
- [ ] 验证公司库检索与显示链路（仅用公司 ID）
- [ ] 验证系统创建（同名线路筛选）与地图多线路展示
- [ ] 验证编辑设施批量修改是否正确写入
