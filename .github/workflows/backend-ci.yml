name: Backend CI

on:
  workflow_dispatch:
  push:
    branches:
      - "**"
    paths:
      - "backend/**"
  pull_request:
    branches:
      - "**"
    paths:
      - "backend/**"

permissions:
  contents: read

jobs:
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --------------------
      # Build backend
      # --------------------
      - name: Build backend in Docker
        env:
          DATABASE_URL: "postgresql://prisma:prisma@127.0.0.1:5432/prisma?schema=public"
        run: |
          docker run --rm \
            -e DATABASE_URL="$DATABASE_URL" \
            -v "$GITHUB_WORKSPACE":/app \
            -w /app \
            node:24-bookworm \
            bash -lc '
              set -e
              corepack enable
              corepack prepare pnpm@9 --activate
              pnpm install --frozen-lockfile
              pnpm --filter @hydroline/backend exec prisma generate
              pnpm --filter @hydroline/backend build
            '
