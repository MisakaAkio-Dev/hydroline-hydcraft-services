generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                          String                                @id @default(uuid())
  name                                        String?
  email                                       String                                @unique
  password                                    String?
  image                                       String?
  createdAt                                   DateTime                              @default(now())
  updatedAt                                   DateTime                              @updatedAt
  emailVerified                               Boolean                               @default(false)
  nameChangedAt                               DateTime?
  joinDate                                    DateTime?
  lastLoginAt                                 DateTime?
  lastLoginIp                                 String?
  passwordNeedsReset                          Boolean                               @default(false)
  passwordUpdatedAt                           DateTime?
  avatarAttachmentId                          String?
  accounts                                    Account[]
  adminAuditLogs                              AdminAuditLog[]                       @relation("AdminAuditActor")
  createdFolders                              AttachmentFolder[]                    @relation("AttachmentFolderCreator")
  shareTokens                                 AttachmentShareToken[]                @relation("AttachmentShareCreator")
  tagAssignments                              AttachmentTagging[]                   @relation("AttachmentTaggingAssignee")
  createdTags                                 AttachmentTag[]                       @relation("AttachmentTagCreator")
  uploadedAttachments                         Attachment[]                          @relation("AttachmentUploader")
  authmeBindingHistoryOps                     AuthmeBindingHistory[]                @relation("AuthmeBindingHistoryOperator")
  authmeBindingHistory                        AuthmeBindingHistory[]                @relation("AuthmeBindingHistoryUser")
  updatedConfigEntries                        ConfigEntry[]                         @relation("ConfigEntryUpdater")
  createdMinecraftServers                     MinecraftServer[]                     @relation("MinecraftServerCreatedBy")
  updatedMinecraftServers                     MinecraftServer[]                     @relation("MinecraftServerUpdatedBy")
  oauthLogs                                   OAuthLog[]
  sessions                                    Session[]
  authmeBindingOperations                     UserAuthmeBinding[]                   @relation("AuthmeBindingOperator")
  authmeBindings                              UserAuthmeBinding[]
  contacts                                    UserContact[]
  lifecycle                                   UserLifecycleEvent[]
  minecraftIds                                UserMinecraftProfile[]
  permissionLabelOps                          UserPermissionLabel[]                 @relation("PermissionLabelOperator")
  permissionLabels                            UserPermissionLabel[]
  piicHistory                                 UserPiicHistory[]
  profile                                     UserProfile?
  biography                                   PlayerBiography?                      @relation("PlayerBiographyOwner")
  biographyUpdates                            PlayerBiography[]                     @relation("PlayerBiographyUpdater")
  roles                                       UserRole[]
  messagesSent                                PlayerMessage[]                       @relation("PlayerMessagesAuthor")
  messagesReceived                            PlayerMessage[]                       @relation("PlayerMessagesReceived")
  messageReactions                            PlayerMessageReaction[]
  statusEvents                                UserStatusEvent[]
  statusSnapshot                              UserStatusSnapshot?
  likesGiven                                  PlayerLike[]                          @relation("PlayerLikesGiven")
  likesReceived                               PlayerLike[]                          @relation("PlayerLikesReceived")
  rankPlayerSnapshots                         RankPlayerSnapshot[]                  @relation("RankSnapshotsForUser")
  rankSyncJobs                                RankSyncJob[]                         @relation("RankSyncJobsInitiated")
  companyMemberships                          CompanyMember[]                       @relation("CompanyMemberUser")
  companyApplications                         CompanyApplication[]                  @relation("CompanyApplicationApplicant")
  companyAuditRecords                         CompanyAuditRecord[]                  @relation("CompanyAuditActor")
  companyPoliciesAuthored                     CompanyPolicy[]                       @relation("CompanyPolicyAuthor")
  companyPoliciesUpdated                      CompanyPolicy[]                       @relation("CompanyPolicyEditor")
  workflowActions                             WorkflowAction[]                      @relation("WorkflowActionActor")
  companiesCreated                            Company[]                             @relation("CompanyCreatedBy")
  companiesUpdated                            Company[]                             @relation("CompanyUpdatedBy")
  legalRepresentativeCompanies                Company[]                             @relation("CompanyLegalRepresentative")
  workflowInstancesCreated                    WorkflowInstance[]                    @relation("WorkflowInstanceCreator")
  transportationRailwayFeaturedCreated        TransportationRailwayFeaturedItem[]   @relation("TransportationRailwayFeaturedCreatedBy")
  transportationRailwayFeaturedUpdated        TransportationRailwayFeaturedItem[]   @relation("TransportationRailwayFeaturedUpdatedBy")
  transportationRailwaySyncJobs               TransportationRailwaySyncJob[]        @relation("TransportationRailwaySyncInitiator")
  transportationRailwaySystemsCreated         TransportationRailwaySystem[]         @relation("TransportationRailwaySystemCreatedBy")
  transportationRailwaySystemsUpdated         TransportationRailwaySystem[]         @relation("TransportationRailwaySystemUpdatedBy")
  transportationRailwayCompanyBindingsCreated TransportationRailwayCompanyBinding[] @relation("TransportationRailwayCompanyBindingCreatedBy")
  transportationRailwayCompanyBindingsUpdated TransportationRailwayCompanyBinding[] @relation("TransportationRailwayCompanyBindingUpdatedBy")
  transportationRailwaySystemLogs             TransportationRailwaySystemLog[]      @relation("RailwaySystemLogActor")
  invitesCreated                              InviteCode[]                          @relation("InviteCreatedBy")
  invitesUsed                                 InviteCode[]                          @relation("InviteUsedBy")

  @@map("users")
}

model Account {
  id                    String     @id @default(uuid())
  userId                String
  type                  String
  provider              String
  providerAccountId     String
  scope                 String?
  accountId             String     @unique
  createdAt             DateTime   @default(now())
  password              String?
  providerId            String
  updatedAt             DateTime   @updatedAt
  accessToken           String?
  accessTokenExpiresAt  DateTime?
  idToken               String?
  refreshToken          String?
  refreshTokenExpiresAt DateTime?
  profile               Json?
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  oauthLogs             OAuthLog[]

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
  ipAddress String?
  token     String   @unique
  updatedAt DateTime @updatedAt
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@map("verifications")
}

model UserProfile {
  id                        String                @id @default(uuid())
  userId                    String                @unique
  primaryMinecraftProfileId String?
  piic                      String?               @unique
  piicAssignedAt            DateTime?
  displayName               String?
  birthday                  DateTime?
  gender                    GenderType?           @default(UNSPECIFIED)
  motto                     String?
  timezone                  String?
  locale                    String?
  extra                     Json?
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  primaryAuthmeBindingId    String?
  primaryAuthmeBinding      UserAuthmeBinding?    @relation("PrimaryAuthmeBinding", fields: [primaryAuthmeBindingId], references: [id])
  primaryMinecraftProfile   UserMinecraftProfile? @relation("PrimaryMinecraftProfile", fields: [primaryMinecraftProfileId], references: [id])
  user                      User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model PlayerBiography {
  id          String   @id @default(uuid())
  userId      String   @unique
  markdown    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedById String?
  user        User     @relation("PlayerBiographyOwner", fields: [userId], references: [id], onDelete: Cascade)
  updatedBy   User?    @relation("PlayerBiographyUpdater", fields: [updatedById], references: [id])

  @@map("player_biographies")
}

model PlayerMessage {
  id           String                  @id @default(uuid())
  targetUserId String
  authorId     String
  content      String
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  targetUser   User                    @relation("PlayerMessagesReceived", fields: [targetUserId], references: [id], onDelete: Cascade)
  author       User                    @relation("PlayerMessagesAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  reactions    PlayerMessageReaction[]

  @@map("player_messages")
}

model PlayerMessageReaction {
  id        String                    @id @default(uuid())
  messageId String
  userId    String
  reaction  PlayerMessageReactionType
  createdAt DateTime                  @default(now())
  updatedAt DateTime                  @updatedAt
  message   PlayerMessage             @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User                      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId], name: "uq_player_message_reaction_user")
  @@map("player_message_reactions")
}

model InviteCode {
  id          String    @id @default(uuid())
  code        String    @unique
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById String?
  usedById    String?
  usedAt      DateTime?
  createdBy   User?     @relation("InviteCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  usedBy      User?     @relation("InviteUsedBy", fields: [usedById], references: [id], onDelete: SetNull)

  @@index([createdById])
  @@index([usedById])
  @@map("invite_codes")
}

model TransportationRailwayFeaturedItem {
  id           String                            @id @default(uuid())
  entityType   TransportationRailwayFeaturedType
  serverId     String
  railwayMod   TransportationRailwayMod          @default(MTR)
  entityId     String
  displayOrder Int                               @default(0)
  createdAt    DateTime                          @default(now())
  updatedAt    DateTime                          @updatedAt
  createdById  String?
  updatedById  String?
  createdBy    User?                             @relation("TransportationRailwayFeaturedCreatedBy", fields: [createdById], references: [id])
  updatedBy    User?                             @relation("TransportationRailwayFeaturedUpdatedBy", fields: [updatedById], references: [id])

  @@unique([entityType, serverId, railwayMod, entityId], map: "uq_transportation_railway_featured_scope")
  @@index([displayOrder, createdAt], map: "idx_transportation_railway_featured_order")
  @@map("transportation_railway_mtr_featured_items")
}

model TransportationRailwayRoute {
  id                  String                             @id @default(uuid())
  serverId            String
  railwayMod          TransportationRailwayMod           @default(MTR)
  entityId            String
  dimensionContext    String?
  transportMode       String?
  name                String?
  color               Int?
  filePath            String?
  payload             Json
  lastBeaconUpdatedAt DateTime?
  syncedAt            DateTime
  createdAt           DateTime                           @default(now())
  updatedAt           DateTime                           @updatedAt
  systemRoutes        TransportationRailwaySystemRoute[]

  @@unique([serverId, railwayMod, entityId], map: "uq_transportation_railway_route")
  @@index([serverId, railwayMod, dimensionContext], map: "idx_transportation_railway_route_scope")
  @@map("transportation_railway_routes")
}

model TransportationRailwayStation {
  id                  String                   @id @default(uuid())
  serverId            String
  railwayMod          TransportationRailwayMod @default(MTR)
  entityId            String
  dimensionContext    String?
  transportMode       String?
  name                String?
  color               Int?
  filePath            String?
  payload             Json
  lastBeaconUpdatedAt DateTime?
  syncedAt            DateTime
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt

  @@unique([serverId, railwayMod, entityId], map: "uq_transportation_railway_station")
  @@index([serverId, railwayMod, dimensionContext], map: "idx_transportation_railway_station_scope")
  @@map("transportation_railway_mtr_stations")
}

model TransportationRailwayPlatform {
  id                  String                   @id @default(uuid())
  serverId            String
  railwayMod          TransportationRailwayMod @default(MTR)
  entityId            String
  dimensionContext    String?
  transportMode       String?
  name                String?
  color               Int?
  filePath            String?
  payload             Json
  lastBeaconUpdatedAt DateTime?
  syncedAt            DateTime
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt

  @@unique([serverId, railwayMod, entityId], map: "uq_transportation_railway_platform")
  @@index([serverId, railwayMod, dimensionContext], map: "idx_transportation_railway_platform_scope")
  @@map("transportation_railway_mtr_platforms")
}

model TransportationRailwayDepot {
  id                  String                   @id @default(uuid())
  serverId            String
  railwayMod          TransportationRailwayMod @default(MTR)
  entityId            String
  dimensionContext    String?
  transportMode       String?
  name                String?
  color               Int?
  filePath            String?
  payload             Json
  lastBeaconUpdatedAt DateTime?
  syncedAt            DateTime
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt

  @@unique([serverId, railwayMod, entityId], map: "uq_transportation_railway_depot")
  @@index([serverId, railwayMod, dimensionContext], map: "idx_transportation_railway_depot_scope")
  @@map("transportation_railway_mtr_depots")
}

model TransportationRailwaySystem {
  id               String                             @id @default(uuid())
  name             String
  englishName      String?
  logoAttachmentId String?
  serverId         String
  dimensionContext String?
  createdAt        DateTime                           @default(now())
  updatedAt        DateTime                           @updatedAt
  createdById      String?
  updatedById      String?
  createdBy        User?                              @relation("TransportationRailwaySystemCreatedBy", fields: [createdById], references: [id])
  updatedBy        User?                              @relation("TransportationRailwaySystemUpdatedBy", fields: [updatedById], references: [id])
  logoAttachment   Attachment?                        @relation("TransportationRailwaySystemLogo", fields: [logoAttachmentId], references: [id])
  routes           TransportationRailwaySystemRoute[]
  logs             TransportationRailwaySystemLog[]

  @@index([serverId, dimensionContext], map: "idx_transportation_railway_system_scope")
  @@map("transportation_railway_systems")
}

model TransportationRailwaySystemLog {
  id        String                      @id @default(uuid())
  systemId  String
  userId    String
  action    String // CREATE, EDIT, DELETE
  createdAt DateTime                    @default(now())
  system    TransportationRailwaySystem @relation(fields: [systemId], references: [id], onDelete: Cascade)
  user      User                        @relation("RailwaySystemLogActor", fields: [userId], references: [id])

  @@index([systemId])
  @@map("transportation_railway_system_logs")
}

model TransportationRailwaySystemRoute {
  id        String                      @id @default(uuid())
  systemId  String
  routeId   String
  createdAt DateTime                    @default(now())
  system    TransportationRailwaySystem @relation(fields: [systemId], references: [id], onDelete: Cascade)
  route     TransportationRailwayRoute  @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@unique([systemId, routeId], map: "uq_transportation_railway_system_route")
  @@index([routeId], map: "idx_transportation_railway_system_route_route")
  @@map("transportation_railway_system_routes")
}

model TransportationRailwayCompanyBinding {
  id               String                                  @id @default(uuid())
  bindingType      TransportationRailwayCompanyBindingType
  entityType       TransportationRailwayBindingEntityType
  entityId         String
  serverId         String?
  railwayMod       TransportationRailwayMod?
  dimensionContext String?
  companyId        String
  createdAt        DateTime                                @default(now())
  updatedAt        DateTime                                @updatedAt
  createdById      String?
  updatedById      String?
  company          Company                                 @relation(fields: [companyId], references: [id])
  createdBy        User?                                   @relation("TransportationRailwayCompanyBindingCreatedBy", fields: [createdById], references: [id])
  updatedBy        User?                                   @relation("TransportationRailwayCompanyBindingUpdatedBy", fields: [updatedById], references: [id])

  @@unique([bindingType, entityType, entityId, companyId], map: "uq_transportation_railway_company_binding")
  @@index([companyId], map: "idx_transportation_railway_company_binding_company")
  @@index([entityType, entityId], map: "idx_transportation_railway_company_binding_entity")
  @@index([serverId, railwayMod, dimensionContext], map: "idx_transportation_railway_company_binding_scope")
  @@map("transportation_railway_mtr_company_bindings")
}

model TransportationRailwayRail {
  id                  String                   @id @default(uuid())
  serverId            String
  railwayMod          TransportationRailwayMod @default(MTR)
  entityId            String
  dimensionContext    String?
  transportMode       String?
  name                String?
  color               Int?
  filePath            String?
  payload             Json
  lastBeaconUpdatedAt DateTime?
  syncedAt            DateTime
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt

  @@unique([serverId, railwayMod, entityId], map: "uq_transportation_railway_rail")
  @@index([serverId, railwayMod, dimensionContext], map: "idx_transportation_railway_rail_scope")
  @@map("transportation_railway_mtr_rails")
}

model TransportationRailwaySignalBlock {
  id                  String                   @id @default(uuid())
  serverId            String
  railwayMod          TransportationRailwayMod @default(MTR)
  entityId            String
  dimensionContext    String?
  transportMode       String?
  name                String?
  color               Int?
  filePath            String?
  payload             Json
  lastBeaconUpdatedAt DateTime?
  syncedAt            DateTime
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt

  @@unique([serverId, railwayMod, entityId], map: "uq_transportation_railway_signal_block")
  @@index([serverId, railwayMod, dimensionContext], map: "idx_transportation_railway_signal_scope")
  @@map("transportation_railway_mtr_signal_blocks")
}

model TransportationRailwayDimension {
  id               String                   @id @default(uuid())
  serverId         String
  railwayMod       TransportationRailwayMod @default(MTR)
  dimensionContext String
  namespace        String?
  dimension        String?
  lastUpdated      DateTime?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt

  @@unique([serverId, railwayMod, dimensionContext], map: "uq_transportation_railway_dimension")
  @@map("transportation_railway_mtr_dimensions")
}

model TransportationRailwaySyncJob {
  id            String                          @id @default(uuid())
  serverId      String
  status        TransportationRailwaySyncStatus @default(PENDING)
  message       String?
  initiatedById String?
  createdAt     DateTime                        @default(now())
  startedAt     DateTime?
  completedAt   DateTime?

  server    MinecraftServer @relation("TransportationRailwaySyncServer", fields: [serverId], references: [id], onDelete: Cascade)
  initiator User?           @relation("TransportationRailwaySyncInitiator", fields: [initiatedById], references: [id])

  @@index([serverId, status], map: "idx_transportation_railway_sync_jobs")
  @@map("transportation_railway_mtr_sync_jobs")
}

model TransportationRailwayRouteGeometrySnapshot {
  id                String                   @id @default(uuid())
  serverId          String
  railwayMod        TransportationRailwayMod @default(MTR)
  dimensionContext  String
  routeEntityId     String
  sourceFingerprint String
  status            String
  errorMessage      String?
  geometry2d        Json
  bounds            Json?
  stops             Json?
  pathNodes3d       Json?
  pathEdges         Json?
  generatedAt       DateTime
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt

  @@unique([serverId, railwayMod, dimensionContext, routeEntityId], map: "uq_transportation_railway_route_geometry_snapshot")
  @@index([serverId, railwayMod, dimensionContext], map: "idx_transportation_railway_route_geometry_scope")
  @@map("transportation_railway_mtr_route_geometry_snapshots")
}

model TransportationRailwayStationMapSnapshot {
  id                String                   @id @default(uuid())
  serverId          String
  railwayMod        TransportationRailwayMod @default(MTR)
  dimensionContext  String
  stationEntityId   String
  sourceFingerprint String
  payload           Json
  generatedAt       DateTime
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt

  @@unique([serverId, railwayMod, dimensionContext, stationEntityId], map: "uq_transportation_railway_station_map_snapshot")
  @@index([serverId, railwayMod, dimensionContext], map: "idx_transportation_railway_station_map_scope")
  @@map("transportation_railway_mtr_station_map_snapshots")
}

model TransportationRailwayComputeScope {
  id               String                   @id @default(uuid())
  serverId         String
  railwayMod       TransportationRailwayMod @default(MTR)
  dimensionContext String
  fingerprint      String
  status           String
  message          String?
  computedAt       DateTime?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt

  @@unique([serverId, railwayMod, dimensionContext], map: "uq_transportation_railway_compute_scope")
  @@index([serverId, railwayMod, fingerprint], map: "idx_transportation_railway_compute_scope_fingerprint")
  @@map("transportation_railway_mtr_compute_scopes")
}

model TransportationRailwayLog {
  id               String                   @id @default(uuid())
  serverId         String
  railwayMod       TransportationRailwayMod @default(MTR)
  beaconLogId      Int
  timestamp        String?
  playerName       String?
  playerUuid       String?
  className        String?
  entryId          String?
  entryName        String?
  position         String?
  changeType       String?
  oldData          String?
  newData          String?
  sourceFilePath   String?
  sourceLine       Int?
  dimensionContext String?
  syncedAt         DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt

  @@unique([serverId, beaconLogId], map: "uq_transportation_railway_mtr_log_beacon")
  @@index([serverId, railwayMod, entryId], map: "idx_transportation_railway_mtr_log_entry")
  @@index([serverId, railwayMod, dimensionContext], map: "idx_transportation_railway_mtr_log_dimension")
  @@index([serverId, railwayMod, beaconLogId], map: "idx_transportation_railway_mtr_log_beacon")
  @@map("transportation_railway_mtr_logs")
}

model UserPiicHistory {
  id            String     @id @default(uuid())
  userId        String
  piic          String
  status        PIICStatus @default(ACTIVE)
  reason        String?
  metadata      Json?
  generatedAt   DateTime   @default(now())
  revokedAt     DateTime?
  generatedById String?
  revokedById   String?
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([piic], map: "idx_user_piic_history_piic")
  @@index([userId, generatedAt], map: "idx_user_piic_history_user")
  @@map("user_piic_history")
}

model UserMinecraftProfile {
  id                String                 @id @default(uuid())
  userId            String
  nickname          String?
  isPrimary         Boolean                @default(false)
  source            MinecraftProfileSource @default(MANUAL)
  verifiedAt        DateTime?
  verificationNote  String?
  metadata          Json?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  authmeBindingId   String?
  authmeUuid        String?
  authmeBinding     UserAuthmeBinding?     @relation(fields: [authmeBindingId], references: [id])
  user              User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  primaryProfileFor UserProfile[]          @relation("PrimaryMinecraftProfile")

  @@index([userId, isPrimary], map: "idx_user_minecraft_primary")
  @@index([authmeBindingId], map: "idx_user_minecraft_binding")
  @@index([authmeUuid], map: "idx_user_minecraft_authme_uuid")
  @@map("user_minecraft_profiles")
}

model UserStatusEvent {
  id           String              @id @default(uuid())
  userId       String
  status       PlayerStatus
  reasonCode   String?
  reasonDetail String?
  source       StatusSource        @default(SYSTEM)
  metadata     Json?
  createdAt    DateTime            @default(now())
  createdById  String?
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  snapshot     UserStatusSnapshot? @relation("StatusSnapshotEvent")

  @@index([userId, createdAt], map: "idx_user_status_user_time")
  @@map("user_status_events")
}

model UserStatusSnapshot {
  userId        String          @id
  statusEventId String          @unique
  status        PlayerStatus
  updatedAt     DateTime        @updatedAt
  event         UserStatusEvent @relation("StatusSnapshotEvent", fields: [statusEventId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_status_snapshot")
}

model UserLifecycleEvent {
  id          String             @id @default(uuid())
  userId      String
  eventType   LifecycleEventType
  occurredAt  DateTime
  source      String?
  notes       String?
  metadata    Json?
  createdAt   DateTime           @default(now())
  createdById String?
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, eventType], map: "idx_user_lifecycle_type")
  @@map("user_lifecycle_events")
}

model RankPlayerSnapshot {
  id                  String             @id @default(uuid())
  serverId            String
  playerUuid          String?
  playerName          String?
  bindingId           String?
  userId              String?
  displayName         String?
  lastLoginAt         DateTime?
  registeredAt        DateTime?
  walkDistanceKm      Float?
  flyDistanceKm       Float?
  swimDistanceKm      Float?
  achievements        Int?
  deaths              Int?
  playerKilledByCount Int?
  jumpCount           Int?
  playTimeHours       Float?
  useWandCount        Int?
  logoutCount         Int?
  mtrBalance          Int?
  metrics             Json?
  stats               Json?
  updatedAt           DateTime           @updatedAt
  server              MinecraftServer    @relation("RankSnapshotsPerServer", fields: [serverId], references: [id], onDelete: Cascade)
  authmeBinding       UserAuthmeBinding? @relation("RankSnapshotsForBinding", fields: [bindingId], references: [id])
  user                User?              @relation("RankSnapshotsForUser", fields: [userId], references: [id])

  @@unique([serverId, playerUuid], map: "uq_rank_snapshot_server_player")
  @@index([serverId], map: "idx_rank_snapshot_server")
  @@map("rank_player_snapshot")
}

model RankSyncJob {
  id            String           @id @default(uuid())
  serverId      String?
  initiatedById String?
  status        RankSyncStatus   @default(PENDING)
  startedAt     DateTime
  completedAt   DateTime?
  message       String?
  createdAt     DateTime         @default(now())
  server        MinecraftServer? @relation("RankSyncJobsPerServer", fields: [serverId], references: [id])
  user          User?            @relation("RankSyncJobsInitiated", fields: [initiatedById], references: [id])

  @@map("rank_sync_jobs")
}

model AuthmeAccountCache {
  id            String   @id @default(uuid())
  username      String
  usernameLower String   @unique(map: "uq_authme_cache_username_lower")
  realname      String?
  ip            String?
  regip         String?
  lastlogin     BigInt?
  regdate       BigInt?
  email         String?
  world         String?
  isLogged      Int      @default(0)
  hasSession    Int      @default(0)
  metadata      Json?
  syncedAt      DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("authme_account_cache")
}

model LuckpermsPlayerCache {
  id            String   @id @default(uuid())
  uuid          String   @unique
  username      String
  usernameLower String   @unique(map: "uq_luckperms_cache_username_lower")
  primaryGroup  String?
  groups        Json?
  syncedAt      DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("luckperms_player_cache")
}

model PlayerDataCache {
  id                    String    @id @default(uuid())
  serverId              String
  identityType          String
  identityKey           String
  playerUuid            String?
  playerName            String?
  playerNameLower       String?
  stats                 Json?
  metrics               Json?
  achievementsTotal     Int?
  statsFetchedAt        DateTime?
  advancementsFetchedAt DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([serverId, identityType, identityKey], map: "uq_playerdata_identity")
  @@index([serverId], map: "idx_playerdata_server")
  @@map("playerdata_cache")
}

model ScheduledTaskState {
  taskId       String    @id
  lastSyncedAt DateTime?
  lastError    String?
  updatedAt    DateTime  @updatedAt

  @@map("scheduled_task_state")
}

enum RankSyncStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

model PlayerLike {
  id        String   @id @default(uuid())
  likerId   String
  targetId  String
  createdAt DateTime @default(now())
  liker     User     @relation("PlayerLikesGiven", fields: [likerId], references: [id], onDelete: Cascade)
  target    User     @relation("PlayerLikesReceived", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([likerId, targetId])
  @@index([targetId])
}

model ContactChannel {
  id              String        @id @default(uuid())
  key             String        @unique
  displayName     String
  description     String?
  validationRegex String?
  isRequired      Boolean       @default(false)
  allowMultiple   Boolean       @default(true)
  isVerifiable    Boolean       @default(false)
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  contacts        UserContact[]

  @@map("contact_channels")
}

model UserContact {
  id               String                    @id @default(uuid())
  userId           String
  channelId        String
  value            String
  isPrimary        Boolean                   @default(false)
  verification     ContactVerificationStatus @default(UNVERIFIED)
  verifiedAt       DateTime?
  verificationCode String?
  metadata         Json?
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  channel          ContactChannel            @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user             User                      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId, value], map: "uq_user_contact_value")
  @@map("user_contacts")
}

model Role {
  id              String           @id @default(uuid())
  key             String           @unique
  name            String
  description     String?
  isSystem        Boolean          @default(false)
  metadata        Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@map("roles")
}

model Permission {
  id               String                      @id @default(uuid())
  key              String                      @unique
  description      String?
  metadata         Json?
  createdAt        DateTime                    @default(now())
  updatedAt        DateTime                    @updatedAt
  labelPermissions PermissionLabelPermission[]
  rolePermissions  RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId], map: "uq_role_permission")
  @@map("role_permissions")
}

model UserRole {
  id           String   @id @default(uuid())
  userId       String
  roleId       String
  assignedById String?
  assignedAt   DateTime @default(now())
  metadata     Json?
  role         Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId], map: "uq_user_role")
  @@index([roleId], map: "idx_user_roles_role")
  @@map("user_roles")
}

model PermissionLabel {
  id          String                      @id @default(uuid())
  key         String                      @unique
  name        String
  description String?
  color       String?
  metadata    Json?
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt
  permissions PermissionLabelPermission[]
  assignments UserPermissionLabel[]

  @@map("permission_labels")
}

model PermissionLabelPermission {
  id           String          @id @default(uuid())
  labelId      String
  permissionId String
  label        PermissionLabel @relation(fields: [labelId], references: [id], onDelete: Cascade)
  permission   Permission      @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([labelId, permissionId], map: "uq_label_permission")
  @@map("permission_label_permissions")
}

model UserPermissionLabel {
  id           String          @id @default(uuid())
  userId       String
  labelId      String
  assignedById String?
  assignedAt   DateTime        @default(now())
  assignedBy   User?           @relation("PermissionLabelOperator", fields: [assignedById], references: [id])
  label        PermissionLabel @relation(fields: [labelId], references: [id], onDelete: Cascade)
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, labelId], map: "uq_user_permission_label")
  @@map("user_permission_labels")
}

model AdminAuditLog {
  id         String   @id @default(uuid())
  actorId    String?
  action     String
  targetType String
  targetId   String?
  payload    Json?
  createdAt  DateTime @default(now())
  actor      User?    @relation("AdminAuditActor", fields: [actorId], references: [id])

  @@index([targetType, targetId], map: "idx_admin_audit_target")
  @@map("admin_audit_log")
}

model OAuthProvider {
  id          String     @id @default(uuid())
  key         String     @unique
  name        String
  type        String
  description String?
  enabled     Boolean    @default(true)
  settings    Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  logs        OAuthLog[]

  @@map("oauth_providers")
}

model OAuthLog {
  id           String         @id @default(uuid())
  providerId   String?
  providerKey  String
  providerType String
  action       OAuthLogAction
  status       OAuthLogStatus
  userId       String?
  accountId    String?
  ip           String?
  userAgent    String?
  message      String?
  metadata     Json?
  createdAt    DateTime       @default(now())
  account      Account?       @relation(fields: [accountId], references: [id])
  provider     OAuthProvider? @relation(fields: [providerId], references: [id])
  user         User?          @relation(fields: [userId], references: [id])

  @@index([providerKey, createdAt], map: "idx_oauth_log_provider_key")
  @@index([userId, createdAt], map: "idx_oauth_log_user")
  @@map("oauth_logs")
}

model OAuthState {
  id         String    @id @default(uuid())
  state      String    @unique
  payload    Json
  result     Json?
  consumedAt DateTime?
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([expiresAt], map: "idx_oauth_state_expiry")
  @@map("oauth_states")
}

model UserAuthmeBinding {
  authmeRealname      String?
  authmeUsername      String
  authmeUsernameLower String                 @unique
  boundAt             DateTime               @default(now())
  boundByIp           String?
  boundByUserId       String?
  updatedAt           DateTime               @updatedAt
  userId              String
  id                  String                 @id @default(uuid())
  authmeUuid          String?                @unique
  lastSyncedAt        DateTime?
  metadata            Json?
  notes               String?
  status              AuthmeBindingStatus    @default(ACTIVE)
  historyEntries      AuthmeBindingHistory[]
  boundBy             User?                  @relation("AuthmeBindingOperator", fields: [boundByUserId], references: [id])
  user                User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  minecraftProfiles   UserMinecraftProfile[]
  primaryProfileFor   UserProfile[]          @relation("PrimaryAuthmeBinding")
  rankPlayerSnapshots RankPlayerSnapshot[]   @relation("RankSnapshotsForBinding")

  @@index([authmeUsernameLower], map: "idx_authme_binding_username_lower")
  @@map("user_authme_binding")
}

model AuthmeBindingHistory {
  id                  String              @id @default(uuid())
  bindingId           String?
  authmeUsername      String
  authmeUsernameLower String
  authmeRealname      String?
  authmeUuid          String?
  userId              String?
  operatorId          String?
  action              AuthmeBindingAction
  reason              String?
  payload             Json?
  createdAt           DateTime            @default(now())
  binding             UserAuthmeBinding?  @relation(fields: [bindingId], references: [id])
  operator            User?               @relation("AuthmeBindingHistoryOperator", fields: [operatorId], references: [id])
  user                User?               @relation("AuthmeBindingHistoryUser", fields: [userId], references: [id])

  @@index([authmeUsernameLower], map: "idx_authme_history_username_lower")
  @@index([authmeUuid], map: "idx_authme_history_uuid")
  @@index([userId], map: "idx_authme_history_user")
  @@index([bindingId], map: "idx_authme_history_binding")
  @@map("authme_binding_history")
}

model MinecraftServer {
  id                            String                         @id @default(uuid())
  displayName                   String
  internalCodeCn                String                         @unique(map: "uq_minecraft_server_cn")
  internalCodeEn                String                         @unique
  host                          String
  port                          Int                            @default(25565)
  edition                       MinecraftServerEdition         @default(JAVA)
  description                   String?
  isActive                      Boolean                        @default(true)
  displayOrder                  Int                            @default(0)
  metadata                      Json?
  createdAt                     DateTime                       @default(now())
  updatedAt                     DateTime                       @updatedAt
  createdById                   String?
  updatedById                   String?
  mcsmApiKey                    String?
  mcsmDaemonId                  String?
  mcsmInstanceUuid              String?
  mcsmPanelUrl                  String?
  mcsmRequestTimeoutMs          Int?
  beaconEnabled                 Boolean?                       @default(false)
  beaconEndpoint                String?
  beaconKey                     String?
  dynmapTileUrl                 String?
  transportationRailwayMod      TransportationRailwayMod       @default(MTR)
  beaconRequestTimeoutMs        Int?
  pingRecords                   MinecraftServerPingRecord[]
  createdBy                     User?                          @relation("MinecraftServerCreatedBy", fields: [createdById], references: [id])
  updatedBy                     User?                          @relation("MinecraftServerUpdatedBy", fields: [updatedById], references: [id])
  rankPlayerSnapshots           RankPlayerSnapshot[]           @relation("RankSnapshotsPerServer")
  rankSyncJobs                  RankSyncJob[]                  @relation("RankSyncJobsPerServer")
  transportationRailwaySyncJobs TransportationRailwaySyncJob[] @relation("TransportationRailwaySyncServer")

  @@index([displayOrder], map: "idx_minecraft_server_order")
  @@map("minecraft_servers")
}

model MinecraftServerPingRecord {
  id            String                 @id @default(uuid())
  serverId      String
  edition       MinecraftServerEdition
  latency       Int?
  onlinePlayers Int?
  maxPlayers    Int?
  motd          String?
  raw           Json?
  createdAt     DateTime               @default(now())
  server        MinecraftServer        @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@index([serverId], map: "idx_minecraft_ping_server")
  @@index([createdAt], map: "idx_minecraft_ping_created")
  @@map("minecraft_server_ping_records")
}

model MinecraftPingSettings {
  id              String   @id @default(uuid())
  intervalMinutes Int      @default(5)
  retentionDays   Int      @default(30)
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())

  @@map("minecraft_ping_settings")
}

model AttachmentFolder {
  id               String                   @id @default(uuid())
  name             String
  slug             String
  description      String?
  parentId         String?
  path             String
  createdById      String?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  visibilityLabels String[]                 @default([])
  visibilityMode   AttachmentVisibilityMode @default(PUBLIC)
  visibilityRoles  String[]                 @default([])
  createdBy        User?                    @relation("AttachmentFolderCreator", fields: [createdById], references: [id])
  parent           AttachmentFolder?        @relation("AttachmentFolderHierarchy", fields: [parentId], references: [id])
  children         AttachmentFolder[]       @relation("AttachmentFolderHierarchy")
  attachments      Attachment[]

  @@unique([parentId, name], map: "uq_attachment_folder_parent_name")
  @@map("attachment_folders")
}

model Attachment {
  id                               String                        @id @default(uuid())
  folderId                         String?
  ownerId                          String?
  name                             String
  originalName                     String
  fileName                         String
  mimeType                         String?
  size                             Int
  storageKey                       String
  hash                             String?
  isPublic                         Boolean                       @default(true)
  externalUrl                      String?
  metadata                         Json?
  createdAt                        DateTime                      @default(now())
  updatedAt                        DateTime                      @updatedAt
  deletedAt                        DateTime?
  uploaderNameSnapshot             String?
  uploaderEmailSnapshot            String?
  visibilityLabels                 String[]                      @default([])
  visibilityMode                   AttachmentVisibilityMode      @default(INHERIT)
  visibilityRoles                  String[]                      @default([])
  shareTokens                      AttachmentShareToken[]
  tags                             AttachmentTagging[]
  folder                           AttachmentFolder?             @relation(fields: [folderId], references: [id])
  owner                            User?                         @relation("AttachmentUploader", fields: [ownerId], references: [id])
  transportationRailwaySystemLogos TransportationRailwaySystem[] @relation("TransportationRailwaySystemLogo")

  @@index([folderId], map: "idx_attachments_folder")
  @@index([ownerId], map: "idx_attachments_owner")
  @@map("attachments")
}

model AttachmentTag {
  id          String              @id @default(uuid())
  key         String              @unique
  name        String
  description String?
  createdById String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  taggings    AttachmentTagging[]
  createdBy   User?               @relation("AttachmentTagCreator", fields: [createdById], references: [id])

  @@map("attachment_tags")
}

model AttachmentTagging {
  attachmentId String
  tagId        String
  assignedById String?
  assignedAt   DateTime      @default(now())
  assignedBy   User?         @relation("AttachmentTaggingAssignee", fields: [assignedById], references: [id])
  attachment   Attachment    @relation(fields: [attachmentId], references: [id], onDelete: Cascade)
  tag          AttachmentTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([attachmentId, tagId])
  @@map("attachment_tagging")
}

model AttachmentShareToken {
  id           String     @id @default(uuid())
  attachmentId String
  token        String     @unique
  expiresAt    DateTime
  createdById  String?
  createdAt    DateTime   @default(now())
  attachment   Attachment @relation(fields: [attachmentId], references: [id], onDelete: Cascade)
  createdBy    User?      @relation("AttachmentShareCreator", fields: [createdById], references: [id])

  @@index([attachmentId], map: "idx_attachment_share_tokens_attachment")
  @@map("attachment_share_tokens")
}

model ConfigNamespace {
  id          String        @id @default(uuid())
  key         String        @unique
  name        String
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  entries     ConfigEntry[]

  @@map("config_namespaces")
}

model ConfigEntry {
  id          String          @id @default(uuid())
  namespaceId String
  key         String
  value       Json
  description String?
  version     Int             @default(1)
  updatedById String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  namespace   ConfigNamespace @relation(fields: [namespaceId], references: [id], onDelete: Cascade)
  updatedBy   User?           @relation("ConfigEntryUpdater", fields: [updatedById], references: [id])

  @@unique([namespaceId, key], map: "uq_config_entry_namespace_key")
  @@index([namespaceId], map: "idx_config_entries_namespace")
  @@map("config_entries")
}

model CompanyIndustry {
  id           String               @id @default(uuid())
  code         String               @unique
  name         String
  description  String?
  icon         String?
  color        String?
  metadata     Json?
  parentId     String?
  isActive     Boolean              @default(true)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  parent       CompanyIndustry?     @relation("IndustryHierarchy", fields: [parentId], references: [id])
  children     CompanyIndustry[]    @relation("IndustryHierarchy")
  companies    Company[]
  applications CompanyApplication[] @relation("IndustryApplications")

  @@map("company_industries")
}

model CompanyType {
  id                String               @id @default(uuid())
  code              String               @unique
  name              String
  description       String?
  category          CompanyCategory      @default(ENTERPRISE)
  isDefault         Boolean              @default(false)
  defaultWorkflow   String?
  requiredDocuments String[]             @default([])
  config            Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  companies         Company[]
  applications      CompanyApplication[]

  @@map("company_types")
}

model CompanyPosition {
  code        String            @id
  name        String
  description String?
  role        CompanyMemberRole
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  members     CompanyMember[]   @relation("CompanyMemberPosition")

  @@map("company_positions")
}

model Company {
  id                                   String                                @id @default(uuid())
  name                                 String
  slug                                 String                                @unique
  headline                             String?
  summary                              String?
  description                          String?
  profile                              Json?
  logoAttachmentId                     String?
  registrationNumber                   String?
  unifiedSocialCreditCode              String?
  legalNameSnapshot                    String?
  legalIdSnapshot                      String?
  category                             CompanyCategory                       @default(ENTERPRISE)
  visibility                           CompanyVisibility                     @default(PRIVATE)
  status                               CompanyStatus                         @default(PENDING_REVIEW)
  isIndividualBusiness                 Boolean                               @default(false)
  typeId                               String?
  industryId                           String?
  legalRepresentativeId                String?
  createdById                          String?
  updatedById                          String?
  workflowInstanceId                   String?                               @unique
  workflowDefinitionCode               String?
  workflowState                        String?
  settings                             Json?
  extra                                Json?
  contactEmail                         String?
  contactPhone                         String?
  contactAddress                       String?
  homepageUrl                          String?
  establishedAt                        DateTime?
  approvedAt                           DateTime?
  activatedAt                          DateTime?
  archivedAt                           DateTime?
  lastActiveAt                         DateTime?
  recommendationScore                  Int                                   @default(0)
  highlighted                          Boolean                               @default(false)
  createdAt                            DateTime                              @default(now())
  updatedAt                            DateTime                              @updatedAt
  type                                 CompanyType?                          @relation(fields: [typeId], references: [id])
  industry                             CompanyIndustry?                      @relation(fields: [industryId], references: [id])
  createdBy                            User?                                 @relation("CompanyCreatedBy", fields: [createdById], references: [id])
  updatedBy                            User?                                 @relation("CompanyUpdatedBy", fields: [updatedById], references: [id])
  legalRepresentative                  User?                                 @relation("CompanyLegalRepresentative", fields: [legalRepresentativeId], references: [id])
  workflowInstance                     WorkflowInstance?                     @relation("CompanyWorkflowInstance", fields: [workflowInstanceId], references: [id])
  members                              CompanyMember[]
  policies                             CompanyPolicy[]
  applications                         CompanyApplication[]
  auditRecords                         CompanyAuditRecord[]
  transportationRailwayCompanyBindings TransportationRailwayCompanyBinding[]

  @@index([status, createdAt], map: "idx_companies_status_created")
  @@index([industryId], map: "idx_companies_industry")
  @@index([typeId], map: "idx_companies_type")
  @@map("companies")
}

model CompanyMember {
  id           String            @id @default(uuid())
  companyId    String
  userId       String
  role         CompanyMemberRole
  positionCode String?
  title        String?
  permissions  String[]          @default([])
  isPrimary    Boolean           @default(false)
  metadata     Json?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  company      Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user         User              @relation("CompanyMemberUser", fields: [userId], references: [id], onDelete: Cascade)
  position     CompanyPosition?  @relation("CompanyMemberPosition", fields: [positionCode], references: [code])

  @@unique([companyId, userId, role], map: "uq_company_member_role")
  @@index([userId], map: "idx_company_member_user")
  @@map("company_members")
}

model CompanyApplication {
  id                 String                   @id @default(uuid())
  companyId          String?
  applicantId        String
  typeId             String?
  industryId         String?
  status             CompanyApplicationStatus @default(SUBMITTED)
  currentStage       String?
  payload            Json?
  attachments        Json?
  notes              String?
  rejectReason       String?
  submittedAt        DateTime                 @default(now())
  resolvedAt         DateTime?
  updatedAt          DateTime                 @updatedAt
  workflowInstanceId String?                  @unique
  company            Company?                 @relation(fields: [companyId], references: [id])
  applicant          User                     @relation("CompanyApplicationApplicant", fields: [applicantId], references: [id], onDelete: Cascade)
  workflowInstance   WorkflowInstance?        @relation("ApplicationWorkflowInstance", fields: [workflowInstanceId], references: [id])
  type               CompanyType?             @relation(fields: [typeId], references: [id])
  industry           CompanyIndustry?         @relation("IndustryApplications", fields: [industryId], references: [id])
  auditRecords       CompanyAuditRecord[]

  @@index([applicantId], map: "idx_company_applications_applicant")
  @@index([status], map: "idx_company_applications_status")
  @@map("company_applications")
}

model CompanyAuditRecord {
  id            String              @id @default(uuid())
  companyId     String
  applicationId String?
  actorId       String?
  actionKey     String
  actionLabel   String?
  resultState   String?
  comment       String?
  payload       Json?
  createdAt     DateTime            @default(now())
  company       Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  application   CompanyApplication? @relation(fields: [applicationId], references: [id])
  actor         User?               @relation("CompanyAuditActor", fields: [actorId], references: [id])

  @@index([companyId], map: "idx_company_audit_company")
  @@index([applicationId], map: "idx_company_audit_application")
  @@map("company_audit_records")
}

model CompanyPolicy {
  id          String              @id @default(uuid())
  companyId   String
  code        String?
  title       String
  summary     String?
  content     String
  status      CompanyPolicyStatus @default(DRAFT)
  version     Int                 @default(1)
  effectiveAt DateTime?
  retiredAt   DateTime?
  metadata    Json?
  createdById String?
  updatedById String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  company     Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy   User?               @relation("CompanyPolicyAuthor", fields: [createdById], references: [id])
  updatedBy   User?               @relation("CompanyPolicyEditor", fields: [updatedById], references: [id])

  @@index([companyId], map: "idx_company_policies_company")
  @@map("company_policies")
}

model WorkflowDefinition {
  id           String             @id @default(uuid())
  code         String             @unique
  name         String
  description  String?
  version      Int                @default(1)
  isActive     Boolean            @default(true)
  initialState String
  states       String[]
  roles        String[]           @default([])
  category     String?
  config       Json?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  instances    WorkflowInstance[]

  @@map("workflow_definitions")
}

model WorkflowInstance {
  id             String                 @id @default(uuid())
  definitionId   String
  definitionCode String
  status         WorkflowInstanceStatus @default(ACTIVE)
  currentState   String
  targetType     String
  targetId       String
  context        Json?
  createdById    String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  completedAt    DateTime?
  cancelledAt    DateTime?
  definition     WorkflowDefinition     @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  createdBy      User?                  @relation("WorkflowInstanceCreator", fields: [createdById], references: [id])
  actions        WorkflowAction[]
  company        Company?               @relation("CompanyWorkflowInstance")
  application    CompanyApplication?    @relation("ApplicationWorkflowInstance")

  @@index([targetType, targetId], map: "idx_workflow_instances_target")
  @@map("workflow_instances")
}

model WorkflowAction {
  id         String           @id @default(uuid())
  instanceId String
  state      String
  actionKey  String
  actionName String?
  actorId    String?
  actorRole  String?
  comment    String?
  payload    Json?
  createdAt  DateTime         @default(now())
  instance   WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  actor      User?            @relation("WorkflowActionActor", fields: [actorId], references: [id])

  @@index([instanceId], map: "idx_workflow_actions_instance")
  @@map("workflow_actions")
}

enum CompanyStatus {
  DRAFT
  PENDING_REVIEW
  UNDER_REVIEW
  NEEDS_REVISION
  ACTIVE
  SUSPENDED
  REJECTED
  ARCHIVED
}

enum CompanyVisibility {
  PUBLIC
  PRIVATE
  INTERNAL
}

enum CompanyMemberRole {
  OWNER
  LEGAL_PERSON
  EXECUTIVE
  MANAGER
  MEMBER
  AUDITOR
}

enum CompanyApplicationStatus {
  SUBMITTED
  UNDER_REVIEW
  NEEDS_CHANGES
  APPROVED
  REJECTED
  ARCHIVED
}

enum CompanyPolicyStatus {
  DRAFT
  ACTIVE
  SUSPENDED
  ARCHIVED
}

enum CompanyCategory {
  ENTERPRISE
  INDIVIDUAL
  ORGANIZATION
}

enum WorkflowInstanceStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PlayerStatus {
  ACTIVE
  AWAY
  UNKNOWN
  BANNED
  ABNORMAL
}

enum StatusSource {
  SYSTEM
  ADMIN
  EXTERNAL
}

enum LifecycleEventType {
  REGISTERED
  MC_JOIN
  MC_LEAVE
  ACCOUNT_BIND
  ACCOUNT_UNBIND
  STATUS_CHANGE
  PROFILE_UPDATE
  CONTACT_UPDATE
  OTHER
}

enum AuthmeBindingAction {
  BIND
  UNBIND
  PRIMARY_SET
  PRIMARY_UNSET
  TRANSFER
  SYNC
  MANUAL_ENTRY
}

enum AuthmeBindingStatus {
  ACTIVE
  DETACHED
  TRANSFERRED
}

enum ContactVerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  FAILED
}

enum MinecraftProfileSource {
  MANUAL
  LUCKPERMS
  AUTHME
  MOJANG
  IMPORT
  OTHER
}

enum MinecraftServerEdition {
  JAVA
  BEDROCK
}

enum GenderType {
  UNSPECIFIED
  MALE
  FEMALE
  NON_BINARY
  OTHER
}

enum PIICStatus {
  ACTIVE
  REVOKED
}

enum PlayerMessageReactionType {
  UP
  DOWN
}

enum AttachmentVisibilityMode {
  INHERIT
  PUBLIC
  RESTRICTED
}

enum OAuthLogAction {
  AUTHORIZE
  TOKEN
  LOGIN
  REGISTER
  BIND
  UNBIND
  ERROR
}

enum OAuthLogStatus {
  SUCCESS
  FAILURE
}

enum TransportationRailwayMod {
  MTR
}

enum TransportationRailwayFeaturedType {
  ROUTE
  STATION
  DEPOT
}

enum TransportationRailwayBindingEntityType {
  ROUTE
  STATION
  DEPOT
  SYSTEM
}

enum TransportationRailwayCompanyBindingType {
  OPERATOR
  BUILDER
}

enum TransportationRailwaySyncStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
}
